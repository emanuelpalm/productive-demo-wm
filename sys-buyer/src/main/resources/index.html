<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Workflow Demo - Buyer</title>
    <style>
        html {
            color: #333;
        }

        body {
            align-items: start;
            background-color: #eee;
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        body > .offer {
            display: flex;
            flex-direction: column;
            margin-right: 1rem;
        }

        h1 {
            font-size: 1.75rem;
            margin: 0 0 1rem 0;
        }

        #offer-form {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 0.2rem 0.1rem #00000020;
            display: grid;
            grid-template-columns: 10rem 10rem;
            margin: 1rem 0;
            min-height: 20rem;
            padding: 1rem;
            row-gap: 1rem;
        }

        #offer-form > h1 {
            grid-column-start: span 2;
        }

        #offer-form > input[type=submit] {
            grid-column-start: span 2;
            margin: 0;
        }

        #offer-form > select,
        #offer-form > input {
            min-height: 2rem;
        }

        #offer-form > label {
            align-self: center;
        }

        #status {
            border-radius: 0.5rem;
            box-shadow: 0 0.2rem 0.1rem #00000020;
            color: #fff;
            font-family: sans-serif;
            font-size: 0.8rem;
            display: none;
            min-height: 4rem;
            padding: 1rem;
            text-align: justify;
            width: 20rem;
        }

        #status.error {
            background-color: #96232D;
            display: block;
        }

        #status.info {
            background-color: #565E96;
            display: block;
        }

        #status.ok {
            background-color: #23963E;
            display: block;
        }

        #status.warning {
            background-color: #968341;
            display: block;
        }

        .orders {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 0.2rem 0.1rem #00000020;
            display: flex;
            flex-direction: column;
            margin: 1rem 0;
            min-height: 27rem;
            padding: 1rem;
            width: 20rem;
        }

        #orders.error {
            color: #96232D;
        }

        #orders:not(.error) {
            column-gap: 0.25rem;
            display: grid;
            grid-template-columns: 12rem auto;
            row-gap: 0.25rem;
        }

        #orders > div {
            border-bottom: 0.1rem solid #ddd;
            font-family: sans-serif;
            padding: 0.25rem;
        }

        #orders > div.header {
            border-bottom: 0.15rem solid #ccc;
            font-family: inherit;
        }

        #orders > div.number {
            text-align: right;
        }
    </style>
    <script>
        window.onload = function() {
            const $offerForm = document.getElementById("offer-form");
            $offerForm.addEventListener("submit", function(event) {
                event.preventDefault();
                setOfferFormDisabled(true);
                statusInfo("Sending offer ...");
                postJson("/offers", getOfferFormData())
                    .then(function(response) {
                        statusInfo(JSON.stringify(response));
                    })
                    .catch(function(error) {
                        console.log(error);
                        statusError(error.message);
                    })
                    .finally(function() {
                        setOfferFormDisabled(false);
                    });
            });

            let orderPoller;
            let $orders = document.getElementById("orders");
            const pollForOrders = function() {
                orderPoller = window.setInterval(function() {
                     getJson("/orders")
                        .then(function(orders) {
                            $orders.classList.remove("error");
                            $orders.innerText = "";

                            const $h1 = document.createElement("div");
                            $h1.className = "header";
                            $h1.innerText = "Article ID";
                            $orders.appendChild($h1);

                            const $h2 = document.createElement("div");
                            $h2.className = "header";
                            $h2.innerText = "Quantity";
                            $orders.appendChild($h2);

                            (orders || [])
                                .sort(function(a, b) {
                                    return a.articleId.localeCompare(b.articleId);
                                })
                                .forEach(function(order) {
                                    const $articleId = document.createElement("div");
                                    $articleId.innerText = order.articleId;
                                    $orders.appendChild($articleId);

                                    const $quantity = document.createElement("div");
                                    $quantity.classList.add("number");
                                    $quantity.innerText = order.quantity;
                                    $orders.appendChild($quantity);
                                });
                        })
                        .catch(function(error) {
                            console.log(error);
                            $orders.classList.add("error");
                            $orders.innerText = "Failed to retrieve pending manufacturing orders. Trying again in 10 seconds ...";
                            window.clearInterval(orderPoller);
                            window.setTimeout(pollForOrders, 10000);
                        });
                }, 500);
            };
            pollForOrders();
        };

        function statusOk(message) { status("ok", message); }
        function statusWarning(message) { status("warning", message); }
        function statusError(message) { status("error", message); }
        function statusInfo(message) { status("info", message); }

        function getOfferFormData() {
            const data = {};
            document.querySelectorAll("#offer-form > select, #offer-form > input").forEach(function($element) {
                let value;
                if ($element.classList.contains("boolean")) {
                    value = $element.value.trim().toLowerCase();
                    if (value === "true") {
                        value = true;
                    } else if (value === "false") {
                        value = false;
                    }
                    else {
                        throw new Error("Invalid boolean value: " + $element.value);
                    }
                }
                else if ($element.classList.contains("number")) {
                    value = Number.parseFloat($element.value);
                }
                else if ($element.classList.contains("text")) {
                    value = $element.value.trim();
                }
                else {
                    return;
                }
                data[$element.name] = value;
            });
            return data;
        }

        function setOfferFormDisabled(isDisabled) {
            document.querySelectorAll("#offer-form > select, #offer-form > input").forEach(function($element) {
                $element.disabled = isDisabled;
            });
        }

        function status(type, message) {
            const $status = document.getElementById("status");
            $status.className = type;
            $status.innerText = message;
        }

        function getJson(url, headers) {
            return requestJson("GET", url, headers || {}, undefined);
        }

        function postJson(url, headers, payload) {
            if (typeof payload === "undefined") {
                payload = headers;
                headers = {};
            }
            return requestJson("POST", url, headers || {}, payload);
        }

        function requestJson(method, url, headers, payload) {
            if (!headers) {
                headers = {accept: "application/json"};
            }
            else if (!headers.accept) {
                 headers.accept = "application/json";
            }
            if (payload && typeof payload === "object") {
                payload = JSON.stringify(payload);
            }
            return request(method, url, headers, payload)
                .then(function (xhr) {
                    const contentType = (xhr.getResponseHeader("content-type") || "").trim().toLowerCase();
                    if (!contentType.startsWith("application/json")) {
                        throw {
                            "name": "badResponseType",
                            "message": "Expected JSON-formatted response from server; received `" + contentType + "`.",
                            "data": xhr
                        };
                    }
                    return JSON.parse(xhr.responseText);
                });
        }

        function request(method, url, headers, payload) {
            return new Promise(function(resolve, reject) {
                const xhr = new XMLHttpRequest();
                xhr.timeout = 3000; // 3 seconds.
                xhr.open(method, url);
                xhr.addEventListener("load", function() {
                    if (this.status >= 200 && this.status <= 299) {
                        resolve(this);
                    } else {
                        reject({
                            "name": "badResponseStatus",
                            "message": "An unexpected status code was received from server (" + this.status + ").",
                            "data": this
                        });
                    }
                });
                xhr.addEventListener("error", function() {
                    reject({
                        "name": "error",
                        "message": "Failed to send request to server.",
                        "data": this
                    });
                });
                xhr.addEventListener("timeout", function() {
                    reject({
                        "name": "timeout",
                        "message": "Server failed to respond to sent request within " + (xhr.timeout / 1000.0) +
                            " seconds.",
                        "data": this
                    });
                });
                for (const [key, value] of Object.entries(headers)) {
                    xhr.setRequestHeader(key, value.toString());
                }
                xhr.send(payload);
            });
        }
    </script>
</head>
<body>
    <section class="offer">
        <form id="offer-form">
            <h1>Buyer Offer</h1>
            <label>Drilled?</label>
            <select name="drilled" class="boolean">
                <option value="true">Yes</option>
                <option selected="selected" value="false">No</option>
            </select>
            <label>Milled?</label>
            <select name="milled" class="boolean">
                <option value="true">Yes</option>
                <option selected="selected" value="false">No</option>
            </select>
            <label>Quantity</label>
            <input type="number" name="quantity" min="1" step="1" value="1" class="number" />
            <label>Unit Price, Euro</label>
            <input type="text" name="unit_price" min="0.00" pattern="[0-9]+(\.[0-9]{2})?" value="420.00" style="text-align: right;" class="number" />
            <input id="offer-form-submit" type="submit" value="Send">
        </form>
        <div id="status" class="info">Click "Send" to submit a new production order offer to the manufacturer. Accepted
            and pending orders are listed to the right.</div>
    </section>
    <section class="orders">
        <h1>In-Progress Orders</h1>
        <div id="orders"></div>
    </section>
</body>
</html>